pipeline {
    agent any

    environment {
        REPO_URL = 'https://github.com/Parasharam-DevOps/cassandra-ansible-role.git'
        INSTALL_WORKSPACE = "/var/lib/jenkins/workspace/Cassandra-DB-Ansible-Role"
        ANSIBLE_PRIVATE_KEY = "/var/lib/jenkins/workspace/Cassandra-DB-Terraform_Infra/private-key.pem"
    }

    stages {
        stage('Clone Repository') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], userRemoteConfigs: [[url: "${REPO_URL}"]]])
            }
        }

        stage('List Active Cassandra Servers') {
            steps {
                sh "ansible-inventory --graph"
            }
        }

        stage('Approval For Apply') {
        
            steps {
                input "Do you want to Install Cassandra Into The Server?"
            }
        }


        stage('Installing Cassandra') {
            steps {
                sh "ansible-playbook -i ${ANSIBLE_PRIVATE_KEY} ${env.INSTALL_WORKSPACE}/master.yml --tags 'install_cassandra_ubuntu'"
                sh "ansible-playbook -i ${ANSIBLE_PRIVATE_KEY} ${env.INSTALL_WORKSPACE}/master.yml --tags 'install_cassandra_redhat'"
            }
        }

        stage('Updating Cassandra Configuration') {
            steps {
                sh "ansible-playbook -i ${ANSIBLE_PRIVATE_KEY} ${env.INSTALL_WORKSPACE}/master.yml --tags 'change_ubuntu_config'"
                sh "ansible-playbook -i ${ANSIBLE_PRIVATE_KEY} ${env.INSTALL_WORKSPACE}/master.yml --tags 'change_redhat_config'"
            }
        }
    }

    post {
        success {
            echo 'Succeeded!'
        }
        failure {
            echo 'Failed!'
        }
    }
}
