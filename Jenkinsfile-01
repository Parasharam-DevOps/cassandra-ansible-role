pipeline {
    agent any

    environment {
        ANSIBLE_PRIVATE_KEY = credentials('terraform.pem')
        REPO_URL = 'https://github.com/parsugit/cassandra-ansible-role.git'
    }

    stages {
        stage('Clone Repository') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], userRemoteConfigs: [[url: "${REPO_URL}"]]])
            }
        }

        stage('List Active Cassandra Servers') {
            steps {
                sh "ansible-inventory --graph"
            }
        }

        stage('Installing Cassandra') {
            steps {
                sh "ansible-playbook --private-key=${ANSIBLE_PRIVATE_KEY} cassandra-tool/tests/test.yml --tags 'install_cassandra_ubuntu'"
                sh "ansible-playbook --private-key=${ANSIBLE_PRIVATE_KEY} cassandra-tool/tests/test.yml --tags 'install_cassandra_redhat'"

            }
        }
        stage('Updating Cassandra Configuration') {
            steps {
                sh "ansible-playbook --private-key=${ANSIBLE_PRIVATE_KEY} cassandra-tool/tests/test.yml --tags 'change_ubuntu_config'"
                sh "ansible-playbook --private-key=${ANSIBLE_PRIVATE_KEY} cassandra-tool/tests/test.yml --tags 'change_redhat_config'"

            }
        }
    }
}
